name: Publish Artifacts

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write   # required for gh-pages deploy

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Build with MSBuild
        run: msbuild Spectra-Build-Tools.sln /p:Configuration=Release

      - name: Package Artifacts
        run: |
          if ("${env:GITHUB_REF}" -like "refs/tags/v*") {
            $VERSION = "${env:GITHUB_REF}" -replace "refs/tags/v", ""
          } else {
            $VERSION = "${env:GITHUB_SHA}".Substring(0,7)  # fallback to short commit hash
          }

          echo "Using version: $VERSION"

          mkdir "artifacts/org/spectraengine/sbt/$VERSION" -Force
          Copy-Item "x64/Release/*.dll" "artifacts/org/spectraengine/sbt/$VERSION/sbt-$VERSION-windows-x64.dll"
          Copy-Item "x64/Release/*.exe" "artifacts/org/spectraengine/sbt/$VERSION/sbt-$VERSION-windows-x64.exe"

          # Add CNAME so GitHub Pages knows the custom domain
          "maven.spectraengine.org" | Out-File -FilePath artifacts/CNAME -Encoding ASCII
        shell: pwsh

      - name: Generate index.html
        run: |
            @'
            <!doctype html>
            <html lang="en">
            <head>
              <meta charset="utf-8" />
              <meta name="viewport" content="width=device-width,initial-scale=1" />
              <title>maven.spectraengine.org</title>
              <style>
                :root { --fg:#0f172a; --muted:#475569; --bg:#ffffff; --card:#f8fafc; --link:#2563eb; --border:#e2e8f0; }
                * { box-sizing: border-box; }
                body { margin:0; font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji","Segoe UI Emoji"; color:var(--fg); background:var(--bg); }
                header { padding:20px 16px; border-bottom:1px solid var(--border); background:#fff; position:sticky; top:0; }
                .wrap { max-width:980px; margin:0 auto; }
                h1 { margin:0 0 6px 0; font-size:18px; }
                .muted { color:var(--muted); }
                nav.breadcrumbs { margin:12px 0 0; font-size:13px; }
                nav.breadcrumbs a { color:var(--link); text-decoration:none; }
                nav.breadcrumbs span.sep { color:var(--muted); margin:0 6px; }
                main { padding:18px 16px 48px; }
                .panel { background:var(--card); border:1px solid var(--border); border-radius:12px; overflow:hidden; }
                .toolbar { display:flex; align-items:center; gap:8px; padding:10px 12px; border-bottom:1px solid var(--border); background:#fff; }
                .toolbar input { width:260px; max-width:100%; padding:8px 10px; border:1px solid var(--border); border-radius:8px; }
                table { width:100%; border-collapse:collapse; }
                th, td { padding:10px 12px; border-bottom:1px solid var(--border); }
                th { text-align:left; font-weight:600; background:#fff; position:sticky; top:72px; }
                tr { padding:10px 12px; }
                tr:hover td { background:#f1f5f9; }
                .name a { text-decoration:none; color:var(--link); }
                .icon { width:26px; text-align:center; }
                .right { text-align:right; color:var(--muted); white-space:nowrap; }
                footer { padding:24px 16px; color:var(--muted); border-top:1px solid var(--border); }
                @media (prefers-color-scheme: dark) {
                  :root { --fg:#e5e7eb; --muted:#94a3b8; --bg:#0b1020; --card:#131a2b; --link:#8ab4ff; --border:#1f2937; }
                  table tr:hover td { background:#0f1626; }
                  header, th, .toolbar, footer { background:#0d1424; }
                }
              </style>
            </head>
            <body>
              <header>
                <div class="wrap">
                  <h1>maven.spectraengine.org</h1>
                  <div class="muted">Static artifact index (gh-pages)</div>
                  <nav class="breadcrumbs" id="breadcrumbs"></nav>
                </div>
              </header>

              <main class="wrap">
                <div class="panel">
                  <div class="toolbar">
                    <input id="search" type="search" placeholder="Filter files/folders…" />
                    <div class="muted" id="count"></div>
                  </div>
                  <table>
                    <thead>
                      <tr>
                        <th class="icon"></th>
                        <th>Name</th>
                        <th>Type</th>
                        <th class="right">Size</th>
                      </tr>
                    </thead>
                    <tbody id="list"></tbody>
                  </table>
                </div>
              </main>

              <footer class="wrap">
                Tip: link to a folder like <code>?path=org/spectraengine/sbt/</code>
              </footer>

            <script>
              const OWNER  = "JTechGaming";
              const REPO   = "Spectra-Build-Tools";
              const BRANCH = "gh-pages";
              const HIDE = new Set(["CNAME", "index.html", "404.html", ".nojekyll"]);

              const $ = (id) => document.getElementById(id);
              const qs = new URLSearchParams(location.search);
              let path = qs.get("path") || "";
              if (path.startsWith("/")) path = path.slice(1);
              if (path && !path.endsWith("/")) path += "/";

              function apiUrl(p) {
                const base = `https://api.github.com/repos/${OWNER}/${REPO}/contents/`;
                return `${base}${encodeURIComponent(p).replace(/%2F/g,'/') }?ref=${BRANCH}`;
              }
              function humanSize(n) {
                if (n == null) return "";
                const units = ["B","KB","MB","GB","TB"];
                let i = 0, v = n;
                while (v >= 1024 && i < units.length-1) { v/=1024; i++; }
                return (i===0? v : v.toFixed(1)) + " " + units[i];
              }
              function gotoFolder(newPath) {
                const u = new URL(location.href);
                u.searchParams.set("path", newPath);
                u.hash = "";
                location.href = u.toString();
              }
              function renderCrumbs() {
                const bc = $("breadcrumbs");
                bc.innerHTML = "";
                const segs = path.split("/").filter(Boolean);
                const make = (label, targetPath) => {
                  const a = document.createElement("a");
                  a.textContent = label;
                  a.href = "javascript:void(0)";
                  a.onclick = () => gotoFolder(targetPath);
                  return a;
                };
                bc.append(make("root", ""));
                let acc = "";
                for (const s of segs) {
                  bc.appendChild(Object.assign(document.createElement("span"), {className:"sep", textContent:"/"}));
                  acc += s + "/";
                  bc.appendChild(make(s, acc));
                }
              }

              async function load() {
                renderCrumbs();
                const resp = await fetch(apiUrl(path));
                if (!resp.ok) {
                  $("list").innerHTML = `<tr><td></td><td colspan="3">Failed to load path <code>${path}</code> (${resp.status})</td></tr>`;
                  $("count").textContent = "";
                  return;
                }
                let items = await resp.json();
                items = items.filter(x => !HIDE.has(x.name));
                items.sort((a,b)=>{
                  if (a.type !== b.type) return a.type === "dir" ? -1 : 1;
                  return a.name.localeCompare(b.name, undefined, {numeric:true});
                });

                const tbody = $("list");
                tbody.innerHTML = "";

                if (path) {
                  const up = path.split("/").filter(Boolean); up.pop();
                  const upPath = up.length ? (up.join("/") + "/") : "";
                  const tr = document.createElement("tr");
                  tr.innerHTML = `
                    <td class="icon">⬆️</td>
                    <td class="name"><a href="javascript:void(0)">..</a></td>
                    <td class="muted">up</td>
                    <td></td>`;
                  tr.querySelector("a").onclick = () => gotoFolder(upPath);
                  tbody.appendChild(tr);
                }

                for (const it of items) {
                  const tr = document.createElement("tr");
                  const isDir = it.type === "dir";
                  const icon = isDir ? "📁" : "📄";
                  const link = document.createElement("a");
                  link.textContent = it.name;

                  if (isDir) {
                    link.href = "javascript:void(0)";
                    link.onclick = () => gotoFolder(path + it.name + "/");
                  } else {
                    link.href = `${location.origin}/${path}${encodeURIComponent(it.name)}`;
                  }

                  tr.innerHTML = `
                    <td class="icon">${icon}</td>
                    <td class="name"></td>
                    <td>${isDir ? "folder" : "file"}</td>
                    <td class="right">${isDir ? "" : humanSize(it.size)}</td>`;
                  tr.querySelector(".name").appendChild(link);
                  tbody.appendChild(tr);
                }

                $("count").textContent = `${items.length} item${items.length===1?"":"s"}`;
                $("search").oninput = (e) => {
                  const q = (e.target.value || "").toLowerCase();
                  [...tbody.children].forEach((tr, i) => {
                    if (path && i===0) return;
                    const a = tr.querySelector(".name a");
                    tr.style.display = a && a.textContent.toLowerCase().includes(q) ? "" : "none";
                  });
                };
              }
              load();
            </script>
            </body>
            </html>
            '@ | Out-File -FilePath artifacts/index.html -Encoding utf8
        shell: pwsh

      - name: Add CNAME
        run: |
          "maven.spectraengine.org" | Out-File -FilePath artifacts/CNAME -Encoding ASCII
        shell: pwsh

      - name: Deploy to Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./artifacts
