name: Publish Artifacts

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write   # required for gh-pages deploy

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Build with MSBuild
        run: msbuild Spectra-Build-Tools.sln /p:Configuration=Release

      - name: Package Artifacts
        run: |
          if ("${env:GITHUB_REF}" -like "refs/tags/v*") {
            $VERSION = "${env:GITHUB_REF}" -replace "refs/tags/v", ""
          } else {
            $VERSION = "${env:GITHUB_SHA}".Substring(0,7)  # fallback to short commit hash
          }

          echo "Using version: $VERSION"

          mkdir "artifacts/org/spectraengine/sbt/$VERSION" -Force
          Copy-Item "x64/Release/*.dll" "artifacts/org/spectraengine/sbt/$VERSION/sbt-$VERSION-windows-x64.dll"
          Copy-Item "x64/Release/*.exe" "artifacts/org/spectraengine/sbt/$VERSION/sbt-$VERSION-windows-x64.exe"

          # Add CNAME so GitHub Pages knows the custom domain
          "maven.spectraengine.org" | Out-File -FilePath artifacts/CNAME -Encoding ASCII
        shell: pwsh

      - name: Generate index.html
        run: |
            function Get-FileTree($path, $relative) {
              $html = ""
              foreach ($item in Get-ChildItem -Force $path) {
                $relPath = if ($relative) { "$relative/$($item.Name)" } else { $item.Name }
                if ($item.PSIsContainer) {
                  $html += "<tr><td class='icon'>📁</td><td class='name'><a href='$relPath/'>$($item.Name)/</a></td><td>folder</td><td class='right'></td></tr>"
                  $html += Get-FileTree $item.FullName $relPath
                } else {
                  $size = [Math]::Round(($item.Length / 1KB), 1)
                  $unit = "KB"
                  if ($size -lt 1) { $size = $item.Length; $unit = "B" }
                  elseif ($size -ge 1024) { $size = [Math]::Round($size / 1024, 1); $unit = "MB" }
                  $html += "<tr><td class='icon'>📄</td><td class='name'><a href='$relPath'>$($item.Name)</a></td><td>file</td><td class='right'>$size $unit</td></tr>"
                }
              }
              return $html
            }

            $tree = Get-FileTree "artifacts" ""

            $html = @"
            <!doctype html>
            <html lang="en">
            <head>
              <meta charset="utf-8" />
              <meta name="viewport" content="width=device-width,initial-scale=1" />
              <title>maven.spectraengine.org</title>
              <style>
                :root { --fg:#0f172a; --muted:#475569; --bg:#ffffff; --card:#f8fafc; --link:#2563eb; --border:#e2e8f0; }
                * { box-sizing: border-box; }
                body { margin:0; font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial,"Apple Color Emoji","Segoe UI Emoji"; color:var(--fg); background:var(--bg); }
                header { padding:20px 16px; border-bottom:1px solid var(--border); background:#fff; position:sticky; top:0; }
                .wrap { max-width:980px; margin:0 auto; }
                h1 { margin:0 0 6px 0; font-size:18px; }
                .muted { color:var(--muted); }
                main { padding:18px 16px 48px; }
                .panel { background:var(--card); border:1px solid var(--border); border-radius:12px; overflow:hidden; }
                table { width:100%; border-collapse:collapse; }
                th, td { padding:10px 12px; border-bottom:1px solid var(--border); }
                th { text-align:left; font-weight:600; background:#fff; position:sticky; top:72px; }
                tr:hover td { background:#f1f5f9; }
                .name a { text-decoration:none; color:var(--link); }
                .icon { width:26px; text-align:center; }
                .right { text-align:right; color:var(--muted); white-space:nowrap; }
                footer { padding:24px 16px; color:var(--muted); border-top:1px solid var(--border); }
                @media (prefers-color-scheme: dark) {
                  :root { --fg:#e5e7eb; --muted:#94a3b8; --bg:#0b1020; --card:#131a2b; --link:#8ab4ff; --border:#1f2937; }
                  table tr:hover td { background:#0f1626; }
                  header, th, footer { background:#0d1424; }
                }
              </style>
            </head>
            <body>
              <header>
                <div class="wrap">
                  <h1>maven.spectraengine.org</h1>
                  <div class="muted">Static artifact index (gh-pages)</div>
                </div>
              </header>

              <main class="wrap">
                <div class="panel">
                  <table>
                    <thead>
                      <tr>
                        <th class="icon"></th>
                        <th>Name</th>
                        <th>Type</th>
                        <th class="right">Size</th>
                      </tr>
                    </thead>
                    <tbody>
                      $tree
                    </tbody>
                  </table>
                </div>
              </main>

              <footer class="wrap">
                Generated by GitHub Actions
              </footer>
            </body>
            </html>
            "@

            $html | Out-File -FilePath artifacts/index.html -Encoding utf8
        shell: pwsh

      - name: Add CNAME
        run: |
          "maven.spectraengine.org" | Out-File -FilePath artifacts/CNAME -Encoding ASCII
        shell: pwsh

      - name: Deploy to Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./artifacts
